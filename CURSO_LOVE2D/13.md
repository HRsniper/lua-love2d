# üíæ Cap√≠tulo 13: Salvando Dados e Persist√™ncia

## üéØ Objetivo

Ensinar como usar `love.filesystem` para salvar e carregar dados em arquivos locais, permitindo persist√™ncia de progresso, configura√ß√µes e estat√≠sticas no jogo de forma segura e multiplataforma.

## üìÅ 13.1 Introdu√ß√£o ao `love.filesystem`

L√ñVE2D permite ler e escrever arquivos dentro da pasta de usu√°rio do jogo, garantindo seguran√ßa e compatibilidade entre sistemas operacionais. O sistema de arquivos √© sandboxed, ou seja, voc√™ s√≥ pode acessar arquivos dentro do diret√≥rio espec√≠fico do seu jogo.

### Localiza√ß√µes dos Arquivos por Sistema:

-   **Windows**: `%APPDATA%/LOVE/[identity]/`
-   **macOS**: `~/Library/Application Support/LOVE/[identity]/`
-   **Linux**: `~/.local/share/love/[identity]/`

### Comandos B√°sicos:

```lua
function love.load()
    -- Define a identidade do jogo (nome da pasta)
    love.filesystem.setIdentity("MeuJogo")

    -- Mostra onde os arquivos ser√£o salvos
    print("Diret√≥rio de save: " .. love.filesystem.getSaveDirectory())

    -- Lista arquivos existentes
    local arquivos = love.filesystem.getDirectoryItems("")
    for i, arquivo in ipairs(arquivos) do
        print("Arquivo encontrado: " .. arquivo)
    end
end
```

### Verificando se um Arquivo Existe:

```lua
function arquivoExiste(nomeArquivo)
    local info = love.filesystem.getInfo(nomeArquivo)
    return info ~= nil and info.type == "file"
end

function diretorioExiste(nomeDiretorio)
    local info = love.filesystem.getInfo(nomeDiretorio)
    return info ~= nil and info.type == "directory"
end

-- Exemplo de uso
if arquivoExiste("config.txt") then
    print("Arquivo de configura√ß√£o encontrado!")
else
    print("Criando arquivo de configura√ß√£o...")
end

print("Arquivo criado com sucesso!")
```

## üß† 13.2 Salvando Dados Simples

### Salvando Texto Simples:

```lua
function salvarPontuacao(pontos)
    local sucesso, mensagem = love.filesystem.write("pontuacao.txt", tostring(pontos))

    if sucesso then
        print("Pontua√ß√£o salva: " .. pontos)
    else
        print("Erro ao salvar: " .. mensagem)
    end

    return sucesso
end

function salvarTexto(arquivo, conteudo)
    return love.filesystem.write(arquivo, conteudo)
end

function salvarConfiguracoes(volume, resolucao)
    local config = volume .. "\n" .. resolucao
    love.filesystem.write("config.txt", config)
end

local pontos = 110
salvarPontuacao(pontos)

salvarTexto("meuArquivo.txt", "Ol√°, mundo!")

local volume = 0.5
local resolucao = "1920x1080"
salvarConfiguracoes(volume, resolucao)

print("Diret√≥rio de save: " .. love.filesystem.getSaveDirectory())
```

### Adicionando ao Arquivo (append):

```lua
function adicionarLog(mensagem)
    local timestamp = os.date("%Y-%m-%d %H:%M:%S")
    local linha = timestamp .. " - " .. mensagem .. "\n"

    love.filesystem.append("game.log", linha)
end

-- Exemplo de uso
adicionarLog("Jogo iniciado")
adicionarLog("N√≠vel 1 completo")
adicionarLog("Game over")

print("Diret√≥rio de save: " .. love.filesystem.getSaveDirectory())
```

## üìñ 13.3 Carregando Dados

### Carregamento B√°sico:

```lua
function arquivoExiste(nome)
    return love.filesystem.getInfo(nome) ~= nil
end

function carregarPontuacao()
    if arquivoExiste("pontuacao.txt") then
        local conteudo = love.filesystem.read("pontuacao.txt")
        local pontos = tonumber(conteudo)

        if pontos then
            return pontos
        else
            print("Erro: arquivo de pontua√ß√£o corrompido")
            return 0
        end
    else
        print("Nenhuma pontua√ß√£o salva encontrada")
        return 0
    end
end

carregarPontuacao()
```

## üß© 13.4 Salvando Dados Estruturados

Para salvar estruturas de dados complexas como tabelas, √© recomendado usar um formato como JSON ou Lua serialization.

### Op√ß√£o 1: Usando Serializa√ß√£o Lua Nativa

```lua
-- Fun√ß√£o para serializar tabelas em Lua
function tabelaParaString(tabela, indentacao)
    indentacao = indentacao or 0
    local espacos = string.rep("  ", indentacao)

    if type(tabela) ~= "table" then
        if type(tabela) == "string" then
            return '"' .. tabela:gsub('"', '\\"') .. '"'
        else
            return tostring(tabela)
        end
    end

    local resultado = "{\n"

    for chave, valor in pairs(tabela) do
        local chaveStr
        if type(chave) == "string" then
            chaveStr = '["' .. chave .. '"]'
        else
            chaveStr = "[" .. chave .. "]"
        end

        resultado = resultado .. espacos .. "  " .. chaveStr .. " = "
        resultado = resultado .. tabelaParaString(valor, indentacao + 1) .. ",\n"
    end

    resultado = resultado .. espacos .. "}"
    return resultado
end

function stringParaTabela(str)
    local env = {
        table = table
    }

    -- O uso de load("return " .. str) pode ser perigoso se voc√™ estiver lidando com dados externos ou modific√°veis pelo usu√°rio. Use bibliotecas seguras como Serpent ou JSON para serializa√ß√£o/desserializa√ß√£o sem execu√ß√£o de c√≥digo.
    local func = load("return " .. str, "dados", "t", env)
    if func then
        return func()
    else
        return nil
    end
end

function arquivoExiste(nome)
    return love.filesystem.getInfo(nome) ~= nil
end

-- Sistema de save/load com serializa√ß√£o
function salvarDados(arquivo, dados)
    local str = tabelaParaString(dados)
    return love.filesystem.write(arquivo, str)
end

function carregarDados(arquivo, padrao)
    if arquivoExiste(arquivo) then
        local conteudo = love.filesystem.read(arquivo)
        local dados = stringParaTabela(conteudo)
        return dados or padrao
    else
        return padrao
    end
end

local jogador = {
    nome = "Carlos",
    nivel = 5,
    experiencia = 1200,
    inventario = {
        espada = true,
        pocao = 3,
        ouro = 250
    }
}
salvarDados("save.txt", jogador)

local dadosCarregados = carregarDados("save.txt")
for key, value in pairs(dadosCarregados) do
    print(key .. ": " .. tostring(value))
end
```

### Op√ß√£o 2: Sistema JSON (Recomendado) ex.:[dkjson](https://github.com/LuaDist/dkjson)

```lua
local json = require("dkjson")

function salvarProgresso(dados)
    local texto = json.encode(dados)
    love.filesystem.write("save.json", texto)
end

function carregarProgresso()
    if love.filesystem.getInfo("save.json") then
        local texto = love.filesystem.read("save.json")
        return json.decode(texto)
    else
        return {nivel = 1, vidas = 3}
    end
end
```

## üîê 13.5 Protegendo Dados

Evite sobrescrever arquivos sem necessidade. Use backups ou verifique antes de salvar:

```lua
if not love.filesystem.getInfo("save.json") then
    salvarProgresso({nivel = 1, vidas = 3})
end
```

## üß© 13.8 Desafio Guiado: Sistema Completo de Persist√™ncia

Crie um jogo simples que implementa um sistema completo de persist√™ncia:

### Requisitos:

```lua
local json = require("json-simu")

local Game = {
    estado = "menu", -- menu, jogo, gameover
    pontuacao = 0,
    recorde = 0,
    nivel = 1,
    vidas = 3,
    tempoJogo = 0,
    configuracoes = {},
    estatisticas = {}
}

function love.load()
    love.filesystem.setIdentity("JogoPersistencia")

    -- Carrega configura√ß√µes
    -- ...

    -- Carrega dados do jogo
    Game.carregarDados()

    print("Jogo carregado! Recorde atual: " .. Game.recorde)
end

function Game.carregarDados()
    local dadosSalvos = json.carregarDados("gamedata.json", {
        recorde = 0,
        estatisticas = {
            partidasJogadas = 0,
            tempoTotalJogo = 0,
            pontuacaoMaxima = 0
        }
    })

    Game.recorde = dadosSalvos.recorde or 0
    Game.estatisticas = dadosSalvos.estatisticas or {}
end

function Game.salvarDados()
    local dados = {
        recorde = math.floor(Game.recorde),
        estatisticas = Game.estatisticas
    }

    json.salvarDados("gamedata.json", dados)
    adicionarLog("Dados salvos - Recorde: " .. Game.recorde)
end

function Game.novaPartida()
    Game.pontuacao = 0
    Game.nivel = 1
    Game.vidas = 3
    Game.tempoJogo = 0
    Game.estado = "jogo"

    Game.estatisticas.partidasJogadas = (Game.estatisticas.partidasJogadas or 0) + 1
end

function Game.gameOver()
    Game.estado = "gameover"

    -- Atualiza estat√≠sticas
    if Game.pontuacao > Game.recorde then
        Game.recorde = Game.pontuacao
        print("Novo recorde! " .. Game.recorde)
    end

    if Game.pontuacao > (Game.estatisticas.pontuacaoMaxima or 0) then
        Game.estatisticas.pontuacaoMaxima = Game.pontuacao
    end

    Game.estatisticas.tempoTotalJogo = (Game.estatisticas.tempoTotalJogo or 0) + Game.tempoJogo

    -- Salva automaticamente
    Game.salvarDados()
end

function adicionarLog(msg)
    print("[LOG] " .. msg)
end

function love.update(dt)
    if Game.estado == "jogo" then
        Game.tempoJogo = Game.tempoJogo + dt

        -- L√≥gica simples do jogo
        Game.pontuacao = Game.pontuacao + dt * 10

        -- Auto-save a cada 30 segundos
        -- ...
    end
end

function love.draw()
    if Game.estado == "menu" then
        love.graphics.print("=== MENU PRINCIPAL ===", 100, 100)
        love.graphics.print("Pressione ENTER para jogar", 100, 130)
        love.graphics.print("Pressione C para configura√ß√µes", 100, 150)
        love.graphics.print("Recorde atual: " .. math.floor(Game.recorde), 100, 180)
    elseif Game.estado == "jogo" then
        love.graphics.print("Pontua√ß√£o: " .. math.floor(Game.pontuacao), 10, 10)
        love.graphics.print("Recorde: " .. math.floor(Game.recorde), 10, 30)
        love.graphics.print("N√≠vel: " .. Game.nivel, 10, 50)
        love.graphics.print("Vidas: " .. Game.vidas, 10, 70)
        love.graphics.print("Tempo: " .. math.floor(Game.tempoJogo) .. "s", 10, 90)

        love.graphics.print("Pressione ESC para sair", 10, 500)
    elseif Game.estado == "gameover" then
        love.graphics.print("=== GAME OVER ===", 100, 200)
        love.graphics.print("Pontua√ß√£o final: " .. math.floor(Game.pontuacao), 100, 230)
        love.graphics.print("Recorde: " .. math.floor(Game.recorde), 100, 250)
        love.graphics.print("Pressione R para jogar novamente", 100, 280)
        love.graphics.print("Pressione ESC para o menu", 100, 300)
    end

    -- Mostra FPS se habilitado
    -- ...
end

function love.keypressed(key)
    if Game.estado == "menu" then
        if key == "return" then
            Game.novaPartida()
        elseif key == "c" then
            -- Abrir menu de configura√ß√µes
        end
    elseif Game.estado == "jogo" then
        if key == "escape" then
            Game.gameOver()
        end
    elseif Game.estado == "gameover" then
        if key == "r" then
            Game.novaPartida()
        elseif key == "escape" then
            Game.estado = "menu"
        end
    end
end

-- Salva dados ao sair
function love.quit()
    Game.salvarDados()
    print("Dados salvos ao sair do jogo!")
end
```

### Funcionalidades do Desafio:

1. **Sistema de Pontua√ß√£o Persistente**: Salva e carrega o recorde
2. **Configura√ß√µes do Usu√°rio**: Volume, resolu√ß√£o, controles
3. **Estat√≠sticas de Jogo**: Tempo total, partidas jogadas, etc.
4. **Auto-save**: Salva automaticamente durante o jogo
5. **M√∫ltiplos Slots**: Sistema de saves diferentes
6. **Backup e Recupera√ß√£o**: Protege contra corrup√ß√£o de dados
7. **Valida√ß√£o**: Verifica integridade dos dados salvos

## ‚úÖ Conclus√£o do Cap√≠tulo

Neste cap√≠tulo voc√™ dominou a persist√™ncia de dados no L√ñVE2D:

### **Fundamentos de `love.filesystem`**:

-   Compreens√£o do sistema de arquivos sandboxed
-   Localiza√ß√£o de arquivos por sistema operacional
-   Opera√ß√µes b√°sicas de leitura e escrita

### **T√©cnicas de Salvamento**:

-   Dados simples em texto
-   Estruturas complexas com JSON
-   Serializa√ß√£o nativa de Lua
-   Sistema de append para logs

### **Seguran√ßa e Robustez**:

-   Valida√ß√£o de dados carregados
-   Sistema de backup autom√°tico
-   Tratamento de erros e recupera√ß√£o
-   Verifica√ß√£o de integridade

### **Sistemas Avan√ßados**:

-   Gerenciador de configura√ß√µes completo
-   Sistema de m√∫ltiplos slots de save
-   Auto-save inteligente
-   Estat√≠sticas e analytics

### **Boas Pr√°ticas**:

-   Estrutura√ß√£o modular do c√≥digo
-   Separa√ß√£o entre dados e l√≥gica
-   Interface amig√°vel para o usu√°rio
-   Otimiza√ß√£o de performance

Estes conceitos s√£o fundamentais para criar jogos profissionais que mant√™m o progresso do jogador e oferecem experi√™ncia personalizada atrav√©s de configura√ß√µes persistentes.

### Recursos √öteis:

-   [Documenta√ß√£o love.filesystem](https://love2d.org/wiki/love.filesystem)
-   [JSON Libraries para Lua](https://github.com/rxi/json.lua)
-   [Padr√µes de Save Game Design](https://gamedevelopment.tutsplus.com/tutorials/how-to-save-and-load-your-players-progress-in-unity--cms-20934)
-   [Data Serialization Best Practices](https://love2d.org/wiki/Tutorial:Serialization)
