# ðŸŽžï¸ CapÃ­tulo 11: AnimaÃ§Ãµes e Tiles

## ðŸŽ¯ Objetivo

Ensinar como criar animaÃ§Ãµes usando spritesheets e como utilizar mapas de tiles para construir cenÃ¡rios com ferramentas como Tiled.

## ðŸ§© 11.1 AnimaÃ§Ãµes com Spritesheets

Spritesheets sÃ£o imagens que contÃªm vÃ¡rios quadros de uma animaÃ§Ã£o organizados em uma Ãºnica imagem. Isso otimiza o carregamento e o uso de memÃ³ria.

### Exemplo: Personagem Correndo

Para uma spritesheet `player.png` com 4 quadros de 32x32 pixels:

```lua
function love.load()
    spriteSheet = love.graphics.newImage("assets/player.png")
    quads = {}
    player = {
        width = 50,
        height = 50,
    }
    -- Cria os quads para cada frame da animaÃ§Ã£o
    for i = 0, 3 do
        quads[i + 1] = love.graphics.newQuad(
            i * player.width, 0,         -- posiÃ§Ã£o x, y na spritesheet
            player.width, player.height, -- largura e altura do frame
            spriteSheet:getDimensions()
        )
    end

    frameAtual = 1
    tempo = 0
end

function love.update(dt)
    tempo = tempo + dt
    -- Troca de frame a cada 0.15 segundos
    if tempo > 0.15 then
        frameAtual = frameAtual % 4 + 1
        tempo = 0
    end
end

function love.draw()
    love.graphics.draw(spriteSheet, quads[frameAtual], 100, 100)
end
```

## ðŸ§  11.2 Criando um Sistema de AnimaÃ§Ã£o

```lua
-- Arquivo: animation.lua
local Animacao = {
    spritesheet = nil,
    quads = {},
    frame = 1,
    tempo = 0,
    intervalo = 0.1,
    spritesheetWH = {
        width = 50,
        height = 50,
    }
}
Animacao.__index = Animacao

function Animacao:new(img)
    local self = setmetatable({}, Animacao)
    self.spritesheet = love.graphics.newImage(img)

    local sheetWidth = self.spritesheet:getWidth()
    local frameCount = sheetWidth / self.spritesheetWH.width
    -- Inserir quads aqui
    for i = 0, frameCount - 1 do
        table.insert(self.quads,
            love.graphics.newQuad(i * self.spritesheetWH.width, 0,
                self.spritesheetWH.width, self.spritesheetWH.height,
                self.spritesheet:getDimensions()))
    end
    return self
end

function Animacao:update(dt)
    self.tempo = self.tempo + dt
    if self.tempo > self.intervalo then
        self.frame = self.frame % #self.quads + 1
        self.tempo = 0
    end
end

function Animacao:draw(x, y)
    love.graphics.draw(self.spritesheet, self.quads[self.frame], x, y)
end

return Animacao

-- Arquivo: main.lua
local animation = require('animation')

function love.load()
    player = animation:new("assets/player.png")
end

function love.update(dt)
    player:update(dt)
end

function love.draw()
    player:draw(100, 100)
end
```

### ðŸ§  Criando um Sistema AvanÃ§ado de AnimaÃ§Ã£o

Exemplo:

Encapsular a lÃ³gica de animaÃ§Ã£o em uma tabela torna o cÃ³digo mais organizado e reutilizÃ¡vel:

```lua
local animacao = {
    spritesheet = nil,
    quads = {},
    frame = 1,
    tempo = 0,
    intervalo = 0.1,
    loop = true
}

function animacao:new(imagePath, frameWidth, frameHeight, numFrames, intervalo)
    local nova = {}
    setmetatable(nova, {__index = self})

    nova.spritesheet = love.graphics.newImage(imagePath)
    nova.quads = {}
    nova.frame = 1
    nova.tempo = 0
    nova.intervalo = intervalo or 0.1
    nova.loop = true

    -- Gera os quads automaticamente
    for i = 0, numFrames - 1 do
        table.insert(nova.quads, love.graphics.newQuad(
            i * frameWidth, 0,
            frameWidth, frameHeight,
            nova.spritesheet:getDimensions()
        ))
    end

    return nova
end

function animacao:update(dt)
    self.tempo = self.tempo + dt

    if self.tempo > self.intervalo then
        if self.loop then
            self.frame = self.frame % #self.quads + 1
        else
            self.frame = math.min(self.frame + 1, #self.quads)
        end
        self.tempo = 0
    end
end

function animacao:draw(x, y, scaleX, scaleY, rotation)
    love.graphics.draw(
        self.spritesheet,
        self.quads[self.frame],
        x, y,
        rotation or 0,
        scaleX or 1,
        scaleY or 1
    )
end

function animacao:reset()
    self.frame = 1
    self.tempo = 0
end

-- Uso do sistema
function love.load()
    playerRun = animacao:new("assets/player_run.png", 32, 32, 4, 0.15)
    playerIdle = animacao:new("assets/player_idle.png", 32, 32, 2, 0.5)

    currentAnimation = playerIdle
end

function love.update(dt)
    -- LÃ³gica para trocar animaÃ§Ãµes
    if love.keyboard.isDown("left", "right") then
        currentAnimation = playerRun
    else
        currentAnimation = playerIdle
    end

    currentAnimation:update(dt)
end

function love.draw()
    currentAnimation:draw(100, 100)
end
```

## ðŸ§± 11.3 Trabalhando com Tiles e Mapas

Tiles sÃ£o pequenos blocos grÃ¡ficos reutilizÃ¡veis usados para construir cenÃ¡rios de forma eficiente. O editor **Tiled** Ã© uma ferramenta visual popular para criar mapas.

### Passo a Passo com Tiled:

1. **InstalaÃ§Ã£o**: Baixe o Tiled em [mapeditor.org](https://www.mapeditor.org/)

2. **CriaÃ§Ã£o do Mapa**:

    - Crie um novo mapa
    - Configure o tamanho dos tiles (ex: 32x32, 18x18, 24x24)
    - Importe uma tileset [imagem com tiles](https://www.youtube.com/watch?v=IHmF_bRpOAE)
    - Desenhe o mapa usando as ferramentas

3. **ExportaÃ§Ã£o**:
    - VÃ¡ em File â†’ Export As
    - Escolha o formato Lua (.lua) para LÃ–VE2D

### Estrutura BÃ¡sica de um Mapa:

```lua
-- Exemplo de mapa exportado do Tiled
return {
  version = "1.9",
  orientation = "orthogonal",
  renderorder = "right-down",
  width = 20,
  height = 15,
  tilewidth = 32,
  tileheight = 32,
  -- ... dados dos layers e tiles
}
```

## ðŸ§© 11.4 Usando STI (Simple Tiled Implementation)

STI Ã© uma biblioteca que facilita o uso de mapas do Tiled no LÃ–VE2D.

### InstalaÃ§Ã£o:

1. Baixe STI: [GitHub - Simple Tiled Implementation](https://github.com/karai17/Simple-Tiled-Implementation)
2. Coloque pasta `sti/` no diretÃ³rio do projeto tipo na pasta `lib`

### BÃ¡sico:

```lua
local sti = require("lib.sti")

function love.load()
    mapa = sti("maps/meu_mapa.lua")
end

function love.update(dt)
    mapa:update(dt)
end

function love.draw()
    mapa:draw()
end
```

### Exemplo AvanÃ§ado:

```lua
local sti = require("sti")

function love.load()
    -- Carrega o mapa exportado do Tiled
    mapa = sti("assets/mapa.lua")

    -- ConfiguraÃ§Ãµes da cÃ¢mera
    camera = {
        x = 0,
        y = 0,
        scale = 1
    }
end

function love.update(dt)
    mapa:update(dt)

    -- Movimento da cÃ¢mera
    local speed = 200
    if love.keyboard.isDown("w") then camera.y = camera.y - speed * dt end
    if love.keyboard.isDown("s") then camera.y = camera.y + speed * dt end
    if love.keyboard.isDown("a") then camera.x = camera.x - speed * dt end
    if love.keyboard.isDown("d") then camera.x = camera.x + speed * dt end
end

function love.draw()
    -- Aplica transformaÃ§Ã£o da cÃ¢mera
    love.graphics.push()
    love.graphics.translate(-camera.x, -camera.y)
    love.graphics.scale(camera.scale)

    -- Desenha o mapa
    mapa:draw()

    love.graphics.pop()
end
```

### Exemplo AvanÃ§ado com Layers:

```lua
local sti = require("sti")

function love.load()
    mapa = sti("assets/mapa.lua")

    -- Remove layers desnecessÃ¡rios para otimizaÃ§Ã£o
    mapa:removeLayer("Metadata")

    -- Acessa layers especÃ­ficos
    backgroundLayer = mapa.layers["Background"]
    foregroundLayer = mapa.layers["Foreground"]
    collisionLayer = mapa.layers["Collision"]
end

function love.draw()
    -- Desenha apenas layers especÃ­ficos
    mapa:drawLayer(backgroundLayer)

    -- Desenha o jogador aqui
    -- ...

    mapa:drawLayer(foregroundLayer)
end
```

## ðŸ§  11.5 ColisÃ£o com Tiles

STI permite detectar colisÃµes com tiles marcados como sÃ³lidos.

```lua
local sti = require("lib.sti")

function love.load()
    mapa = sti("maps/meu_mapa.lua")

    -- Player
    player = {
        x = 100,
        y = 100,
        width = 18,
        height = 18,
        speed = 150
    }
end

function love.update(dt)
    local dx, dy = 0, 0

    -- Input do jogador
    if love.keyboard.isDown("left") then dx = -player.speed * dt end
    if love.keyboard.isDown("right") then dx = player.speed * dt end
    if love.keyboard.isDown("up") then dy = -player.speed * dt end
    if love.keyboard.isDown("down") then dy = player.speed * dt end

    -- Verifica colisÃ£o antes de mover
    if not temColisao(player.x + dx, player.y) then
        player.x = player.x + dx
    end

    if not temColisao(player.x, player.y + dy) then
        player.y = player.y + dy
    end

    mapa:update(dt)
end

function temColisao(x, y)
    local layer = mapa.layers["collision"]
    if not layer then return false end

    local function isSolid(tx, ty)
        local tile = layer.data[ty] and layer.data[ty][tx]
        return tile ~= nil and tile ~= 0
    end

    -- Coordenadas dos cantos do jogador
    local tileX1 = math.floor(x / mapa.tilewidth) + 1
    local tileY1 = math.floor(y / mapa.tileheight) + 1
    local tileX2 = math.floor((x + player.width - 1) / mapa.tilewidth) + 1
    local tileY2 = math.floor((y + player.height - 1) / mapa.tileheight) + 1

    -- Verifica os quatro cantos
    return isSolid(tileX1, tileY1) or isSolid(tileX2, tileY1) or
        isSolid(tileX1, tileY2) or isSolid(tileX2, tileY2)
end

function love.draw()
    mapa:draw()

    -- Desenha o jogador
    love.graphics.setColor(1, 0, 0)
    love.graphics.rectangle("fill", player.x, player.y, player.width, player.height)
    love.graphics.setColor(1, 1, 1)
end

```

## ðŸ§© Exemplo Sistema Completo: Player Animado + Mapa

```lua
local sti = require("sti")

-- Sistema de animaÃ§Ã£o (do cÃ³digo anterior)
local Animacao = {} -- ... (cÃ³digo da seÃ§Ã£o 11.2)

function love.load()
    -- Carrega o mapa
    mapa = sti("assets/level1.lua")

    -- Configura o jogador
    player = {
        x = 64,
        y = 64,
        width = 32,
        height = 32,
        speed = 120,
        direction = "down"
    }

    -- AnimaÃ§Ãµes do jogador
    animations = {
        idle_down = Animacao:new("assets/player_idle_down.png", 32, 32, 2, 0.8),
        walk_down = Animacao:new("assets/player_walk_down.png", 32, 32, 4, 0.15),
        idle_up = Animacao:new("assets/player_idle_up.png", 32, 32, 2, 0.8),
        walk_up = Animacao:new("assets/player_walk_up.png", 32, 32, 4, 0.15),
        idle_left = Animacao:new("assets/player_idle_left.png", 32, 32, 2, 0.8),
        walk_left = Animacao:new("assets/player_walk_left.png", 32, 32, 4, 0.15),
        idle_right = Animacao:new("assets/player_idle_right.png", 32, 32, 2, 0.8),
        walk_right = Animacao:new("assets/player_walk_right.png", 32, 32, 4, 0.15)
    }

    currentAnimation = animations.idle_down

    -- CÃ¢mera
    camera = { x = 0, y = 0 }
end

function love.update(dt)
    local dx, dy = 0, 0
    local moving = false

    -- Input e movimento
    if love.keyboard.isDown("left") then
        dx = -player.speed * dt
        player.direction = "left"
        moving = true
    elseif love.keyboard.isDown("right") then
        dx = player.speed * dt
        player.direction = "right"
        moving = true
    end

    if love.keyboard.isDown("up") then
        dy = -player.speed * dt
        player.direction = "up"
        moving = true
    elseif love.keyboard.isDown("down") then
        dy = player.speed * dt
        player.direction = "down"
        moving = true
    end

    -- Verifica colisÃµes e move
    if not temColisao(player.x + dx, player.y) then
        player.x = player.x + dx
    end

    if not temColisao(player.x, player.y + dy) then
        player.y = player.y + dy
    end

    -- Seleciona animaÃ§Ã£o apropriada
    local animKey = (moving and "walk_" or "idle_") .. player.direction
    local newAnim = animations[animKey]

    if currentAnimation ~= newAnim then
        currentAnimation = newAnim
        currentAnimation:reset()
    end

    currentAnimation:update(dt)

    -- Atualiza cÃ¢mera para seguir o jogador
    camera.x = player.x - love.graphics.getWidth() / 2
    camera.y = player.y - love.graphics.getHeight() / 2

    mapa:update(dt)
end

function love.draw()
    -- Aplica cÃ¢mera
    love.graphics.push()
    love.graphics.translate(-camera.x, -camera.y)

    -- Desenha o mapa
    mapa:draw()

    -- Desenha o jogador
    currentAnimation:draw(player.x, player.y)

    love.graphics.pop()

    -- UI (sem transformaÃ§Ã£o da cÃ¢mera)
    love.graphics.print("Use as setas para mover", 10, 10)
end

function temColisao(x, y)
    local layer = mapa.layers["Collision"]
    if not layer then return false end

    local tileX = math.floor(x / mapa.tilewidth) + 1
    local tileY = math.floor(y / mapa.tileheight) + 1

    local tile = layer.data[tileY] and layer.data[tileY][tileX]
    return tile ~= nil and tile ~= 0
end
```

## ðŸ§© 11.6 Desafio Guiado

Crie um projeto que combine todos os conceitos:

### Requisitos:

1. **Mapa no Tiled**:

    - Crie um mapa 20x15 com tiles de 32x32
    - Use pelo menos 3 layers: Background, Collision, Foreground
    - Adicione obstÃ¡culos e elementos decorativos

2. **Sistema de AnimaÃ§Ã£o**:

    - Implemente animaÃ§Ãµes para pelo menos 4 direÃ§Ãµes
    - Adicione animaÃ§Ãµes idle e walking

3. **Funcionalidades**:
    - Movimento suave do jogador
    - ColisÃ£o com tiles sÃ³lidos
    - CÃ¢mera que segue o jogador
    - TransiÃ§Ã£o fluida entre animaÃ§Ãµes

### Estrutura de Pastas Sugerida:

```
projeto/
â”œâ”€â”€ main.lua
â”œâ”€â”€ assets/
â”‚   â”œâ”€â”€ tilesets/
â”‚   â”‚   â””â”€â”€ terrain.png
â”‚   â”œâ”€â”€ sprites/
â”‚   â”‚   â”œâ”€â”€ player_idle_down.png
â”‚   â”‚   â”œâ”€â”€ player_walk_down.png
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ maps/
â”‚       â””â”€â”€ level1.lua
â”œâ”€â”€ sti.lua
â””â”€â”€ sti/
    â””â”€â”€ ...
```

## âœ… ConclusÃ£o do CapÃ­tulo

Neste capÃ­tulo vocÃª aprendeu:

-   **AnimaÃ§Ãµes com Spritesheets**: Como carregar e reproduzir animaÃ§Ãµes usando quads
-   **Sistema de AnimaÃ§Ã£o**: Como criar um sistema reutilizÃ¡vel e flexÃ­vel para gerenciar animaÃ§Ãµes
-   **Mapas com Tiled**: Como usar o editor Tiled para criar cenÃ¡rios visuais
-   **IntegraÃ§Ã£o STI**: Como carregar e renderizar mapas do Tiled no LÃ–VE2D
-   **ColisÃ£o com Tiles**: Como implementar detecÃ§Ã£o de colisÃ£o baseada em tiles
-   **Projeto Integrado**: Como combinar animaÃ§Ãµes, mapas e colisÃµes em um sistema coeso

### Recursos Ãšteis:

-   [DocumentaÃ§Ã£o do Tiled](https://doc.mapeditor.org/)
-   [STI no GitHub](https://github.com/karai17/Simple-Tiled-Implementation)
-   [Spritesheets gratuitos](https://opengameart.org/)
-   [Tutoriais de pixel art](https://lospec.com/pixel-art-tutorials)
