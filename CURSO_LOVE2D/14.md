# 📦 Capítulo 14: Empacotamento e Distribuição LÖVE2D

## 🎯 Objetivo

Dominar o processo de empacotamento e distribuição de jogos LÖVE2D para múltiplas plataformas, incluindo otimizações e automação do processo.

---

## 📋 Pré-requisitos e Preparação

### ✅ Checklist Antes do Empacotamento

-   [ ] Código finalizado e testado
-   [ ] Assets otimizados (imagens comprimidas, áudios em formato adequado)
-   [ ] Arquivo `main.lua` na raiz do projeto
-   [ ] Estrutura de pastas organizada
-   [ ] Testes realizados em diferentes resoluções
-   [ ] Remoção de arquivos temporários e de desenvolvimento

### 📁 Estrutura de Projeto Recomendada

```
meu_jogo/
├── main.lua
├── conf.lua
├── assets/
│   ├── images/
│   ├── sounds/
│   └── fonts/
├── src/
│   ├── states/
│   ├── entities/
│   └── utils/
├── README.md
└── LICENSE.txt
```

---

## 📦 14.1 Criando Arquivo .love

### Método Manual

Via software:

-   Entre na pasta do jogo
    -   Certifique-se de que main.lua está na raiz da pasta e Clique com o botão direito.
    -   Selecione Enviar para > Pasta compactada (.zip).
    -   Isso criará um arquivo .zip com o conteúdo do jogo.
    -   Renomeie o arquivo para meu_jogo.love.

Via terminal:

```bash
# No diretório do projeto
zip -r meu_jogo.zip * -x "*.git*" "*.DS_Store*" "*Thumbs.db*" "*.md" "*.sh" "*.bat"
mv meu_jogo.zip meu_jogo.love
```

### Teste:

Arraste o arquivo .love sobre o executável do LÖVE ou use:

```sh
love meu_jogo.love
```

### Método com Script de Automação

Script linux `build.sh`:

```bash
#!/bin/bash
set -e  # Encerra o script se algum comando falhar

# Configurações
GAME_NAME="meu_jogo"
VERSION="1.0.0"
BUILD_DIR="builds"
LOVE_FILE="$BUILD_DIR/${GAME_NAME}-v${VERSION}.love"

# Criar diretório de builds
mkdir -p "$BUILD_DIR"

# Remover versões anteriores
echo "Removendo versões anteriores:"
ls "$BUILD_DIR/${GAME_NAME}-v*.love" 2>/dev/null
rm -f "$BUILD_DIR/${GAME_NAME}-v*.love"

# Criar arquivo .love
echo "Criando arquivo .love..."
zip -r "$LOVE_FILE" . \
    -x "$BUILD_DIR/*" ".git/*" "*.DS_Store" "*Thumbs.db" "*.md" "*.bat" ""*.sh" "*.tmx" "*.ps1"

echo "Arquivo .love criado: $LOVE_FILE"

# Testar o jogo se o LÖVE estiver instalado
if command -v love &> /dev/null; then
    echo "Testando arquivo .love..."
    love "$LOVE_FILE"
else
    echo "LÖVE não está instalado ou não está no PATH."
fi
```

Script windows `build.bat`

```batch
@echo off
setlocal

:: Configurações
set "GAME_NAME=meu_jogo"
set "VERSION=1.0.0"
set "BUILD_DIR=builds"
set "LOVE_FILE=%BUILD_DIR%\%GAME_NAME%-v%VERSION%.love"
set "ZIP=C:\Program Files\7-Zip\7z.exe"

:: Verificar se o 7-Zip existe
if not exist "%ZIP%" (
    echo Erro: 7-Zip não encontrado em "%ZIP%"
    exit /b
)

:: Criar diretório de builds
if not exist "%BUILD_DIR%" (
    mkdir "%BUILD_DIR%"
)

:: Remover versões anteriores
echo Removendo versões anteriores:
dir /b "%BUILD_DIR%\%GAME_NAME%-v*.love" 2>nul
del /F /Q "%BUILD_DIR%\%GAME_NAME%-v*.love"

:: Criar arquivo .love
echo Criando arquivo .love...
"%ZIP%" a -tzip "%LOVE_FILE%" * -x!"%BUILD_DIR%\" -x!".git\" -x!"*.DS_Store" -x!"*.Thumbs.db" -x!"*.md" -x!"*.bat" -x!"*.sh" -x!"**\*.tmx" -x!"*.ps1"

echo Arquivo .love criado: %LOVE_FILE%

:: Testar o jogo se o LÖVE estiver instalado
where love >nul 2>nul
if %errorlevel%==0 (
    echo Testando arquivo .love...
    love "%LOVE_FILE%"
) else (
    echo LÖVE não está instalado ou não está no PATH.
)

endlocal
```

---

## 🖥️ 14.2 Criando Executável para Windows

Para isso, você deve anexar seu arquivo `.love` ao arquivo love.exe que acompanha o arquivo oficial
`LÖVE.zip`. O arquivo resultante é o executável do jogo. empacotá-lo junto com todos os outros arquivos DLL do arquivo oficial LÖVE .zip e compartilhá-lo com o mundo.

Para `copy` os 2 arquivos devem estar na mesma raiz:

-   love.exe
-   game.love

```cmd
copy /b love.exe+game.love game.exe
```

### Método Concatenação

```batch
@echo off
set "GAME_NAME=meu_jogo"
set "VERSION=1.0.0"
set "BUILD_DIR=builds"
set "LOVE_FILE=%BUILD_DIR%\%GAME_NAME%-v%VERSION%.love"
set "LOVE_PATH=C:\love\love-11.4-win64"

# Criar executável
copy /b "%LOVE_PATH%\love.exe"+"%LOVE_FILE%" "%LOVE_FILE%.exe"

# Copiar DLLs necessárias
copy "%LOVE_PATH%\*.dll" "%BUILD_DIR%\"
copy "%LOVE_PATH%\license.txt" "%BUILD_DIR%\LOVE-license.txt"

echo Executável Windows criado!
```

### Script Avançado com Ícone

```python
#!/usr/bin/env python3
import os
import shutil
import subprocess
import zipfile

def create_windows_build(game_name, version, love_path, build_dir):
    """Cria build completa para Windows com ícone personalizado"""

    win_dir = f"{build_dir}/windows"
    os.makedirs(win_dir, exist_ok=True)

    # Combinar love.exe com .love
    love_exe = f"{love_path}/love.exe"
    love_file = f"{build_dir}/{game_name}-v{version}.love"
    output_exe = f"{win_dir}/{game_name}.exe"

    with open(output_exe, 'wb') as output:
        with open(love_exe, 'rb') as exe:
            output.write(exe.read())
        with open(love_file, 'rb') as love:
            output.write(love.read())

    # Copiar DLLs
    for file in os.listdir(love_path):
        if file.endswith('.dll'):
            shutil.copy(f"{love_path}/{file}", win_dir)

    # Adicionar ícone (se disponível)
    icon_path = "assets/icon.ico"
    if os.path.exists(icon_path):
        try:
            subprocess.run([
                "rcedit", output_exe,
                "--set-icon", icon_path,
                "--set-file-version", version,
                "--set-product-version", version
            ], check=True)
            print("✅ Ícone adicionado ao executável")
        except:
            print("⚠️ Erro ao adicionar ícone (rcedit não encontrado)")

    print(f"✅ Build Windows criada em: {win_dir}")

# Uso
create_windows_build("meu_jogo", "1.0.0", "C:/love/love-11.4-win64", "builds")
```

---

## 🐧 14.3 Distribuição Linux

Exemplo:

### AppImage (Recomendado)

```bash
#!/bin/bash
GAME_NAME="meu_jogo"
VERSION="1.0.0"
APPDIR="$GAME_NAME.AppDir"

# Criar estrutura AppDir
mkdir -p $APPDIR/usr/bin
mkdir -p $APPDIR/usr/share/applications
mkdir -p $APPDIR/usr/share/icons/hicolor/256x256/apps

# Copiar LÖVE
cp /usr/bin/love $APPDIR/usr/bin/
cp -r /usr/lib/x86_64-linux-gnu/liblove* $APPDIR/usr/bin/ 2>/dev/null || true

# Copiar jogo
cp builds/$GAME_NAME-v$VERSION.love $APPDIR/usr/bin/game.love

# Criar desktop entry
cat > $APPDIR/usr/share/applications/$GAME_NAME.desktop << EOF
[Desktop Entry]
Type=Application
Name=$GAME_NAME
Exec=love game.love
Icon=$GAME_NAME
Comment=Um jogo incrível feito com LÖVE2D
Categories=Game;
EOF

# Copiar ícone
cp assets/icon.png $APPDIR/usr/share/icons/hicolor/256x256/apps/$GAME_NAME.png

# Criar AppRun
cat > $APPDIR/AppRun << 'EOF'
#!/bin/bash
HERE="$(dirname "$(readlink -f "${0}")")"
export LD_LIBRARY_PATH="$HERE/usr/bin:$LD_LIBRARY_PATH"
cd "$HERE/usr/bin"
exec ./love game.love "$@"
EOF

chmod +x $APPDIR/AppRun

# Gerar AppImage
appimagetool $APPDIR $GAME_NAME-v$VERSION-x86_64.AppImage

echo "✅ AppImage criada: $GAME_NAME-v$VERSION-x86_64.AppImage"
```

### Pacote .deb

Exemplo:

```bash
#!/bin/bash
create_deb_package() {
    local GAME_NAME="meu_jogo"
    local VERSION="1.0.0"
    local DEB_DIR="builds/debian"

    # Estrutura do pacote
    mkdir -p $DEB_DIR/DEBIAN
    mkdir -p $DEB_DIR/usr/local/games/$GAME_NAME
    mkdir -p $DEB_DIR/usr/share/applications
    mkdir -p $DEB_DIR/usr/share/icons/hicolor/256x256/apps

    # Copiar arquivos do jogo
    cp builds/$GAME_NAME-v$VERSION.love $DEB_DIR/usr/local/games/$GAME_NAME/

    # Controle do pacote
    cat > $DEB_DIR/DEBIAN/control << EOF
Package: $GAME_NAME
Version: $VERSION
Section: games
Priority: optional
Architecture: all
Depends: love (>= 11.0)
Maintainer: Seu Nome <seu@email.com>
Description: Descrição do seu jogo
 Uma descrição mais longa do seu jogo
 feito com LÖVE2D.
EOF

    # Script de instalação
    cat > $DEB_DIR/usr/share/applications/$GAME_NAME.desktop << EOF
[Desktop Entry]
Type=Application
Name=$GAME_NAME
Exec=love /usr/local/games/$GAME_NAME/$GAME_NAME-v$VERSION.love
Icon=$GAME_NAME
Comment=Um jogo incrível
Categories=Game;
EOF

    # Construir pacote
    dpkg-deb --build $DEB_DIR builds/$GAME_NAME-v$VERSION.deb

    echo "✅ Pacote .deb criado: builds/$GAME_NAME-v$VERSION.deb"
}
```

---

### Distribuição macOS App Bundle Manual

Exemplo:

```bash
#!/bin/bash
create_macos_app() {
    local GAME_NAME="MeuJogo"
    local VERSION="1.0.0"
    local APP_DIR="builds/$GAME_NAME.app"

    # Estrutura do app
    mkdir -p "$APP_DIR/Contents/MacOS"
    mkdir -p "$APP_DIR/Contents/Resources"

    # Info.plist
    cat > "$APP_DIR/Contents/Info.plist" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key>
    <string>$GAME_NAME</string>
    <key>CFBundleIdentifier</key>
    <string>com.seudominio.$GAME_NAME</string>
    <key>CFBundleName</key>
    <string>$GAME_NAME</string>
    <key>CFBundleVersion</key>
    <string>$VERSION</string>
    <key>CFBundleShortVersionString</key>
    <string>$VERSION</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
</dict>
</plist>
EOF

    # Script executável
    cat > "$APP_DIR/Contents/MacOS/$GAME_NAME" << EOF
#!/bin/bash
cd "\$(dirname "\$0")/../Resources"
exec love game.love "\$@"
EOF

    chmod +x "$APP_DIR/Contents/MacOS/$GAME_NAME"

    # Copiar jogo
    cp "builds/meu_jogo-v$VERSION.love" "$APP_DIR/Contents/Resources/game.love"

    # Copiar ícone (se disponível)
    if [ -f "assets/icon.icns" ]; then
        cp "assets/icon.icns" "$APP_DIR/Contents/Resources/"
    fi

    echo "✅ App macOS criado: $APP_DIR"
}
```

---

## 📱 14.5 Android com LÖVE

Exemplo:

### Preparação do Projeto

```lua
-- conf.lua - configurações específicas para Android
function love.conf(t)
    t.title = "Meu Jogo"
    t.version = "11.4"

    -- Configurações Android
    t.window.width = 0  -- Usar tela cheia
    t.window.height = 0
    t.window.fullscreen = true
    t.window.fullscreentype = "desktop"

    -- Otimizações móveis
    t.accelerometerjoystick = true
    t.gammacorrect = false
end
```

### Build Android (usando [love-android](https://github.com/love2d/love-android))

```bash
#!/bin/bash
create_android_build() {
    local GAME_NAME="meu_jogo"
    local PACKAGE_NAME="com.seudominio.meujogo"
    local VERSION="1.0.0"

    # Clone do repositório LÖVE Android
    git clone https://github.com/love2d/love-android.git
    cd love-android

    # Configurar gradle.properties
    cat >> gradle.properties << EOF
applicationName=$GAME_NAME
applicationId=$PACKAGE_NAME
versionCode=1
versionName=$VERSION
EOF

    # Copiar assets
    cp ../builds/$GAME_NAME-v$VERSION.love app/src/main/assets/game.love

    # Build (https://github.com/love2d/love-android/wiki/Game-Packaging#how-to-package-the-apk-with-your-own-l%C3%96ve-game)
    ./gradlew assembleEmbedDebug

    echo "✅ APK criado em: app/build/outputs/apk/"
}
```

---

## 🛠️ 6. Script de Build Universal

Exemplo:

```bash
#!/usr/bin/env bash
set -euo pipefail

# Variáveis (exporte antes ou edite aqui)
GAME_NAME="${GAME_NAME:-MyGame}"
GAME_VERSION="${GAME_VERSION:-0.1.0}"
LOVE_VERSION="${LOVE_VERSION:-11.5}"
ANDROID_SDK="${ANDROID_SDK_ROOT:-$HOME/Android/Sdk}"

WORKDIR="$(pwd)"
DIST="$WORKDIR/dist"
BUILD="$WORKDIR/build"
TMP="$WORKDIR/tmp"

rm -rf "$DIST" "$BUILD" "$TMP"
mkdir -p "$DIST" "$BUILD" "$TMP"

# Gera arquivo .love
echo "→ Empacotando .love"
cd "$WORKDIR"
zip -r "$TMP/$GAME_NAME-$GAME_VERSION.love" . -x "dist/*" "build.sh" "tmp/*"

# Função: Windows (zip com love.exe)
build_windows() {
  echo "→ Build Windows"
  WIN_ZIP="$DIST/${GAME_NAME}-${GAME_VERSION}-win.zip"
  LUV_URL="https://github.com/love2d/love/releases/download/${LOVE_VERSION}/love-${LOVE_VERSION}-win32.zip"
  curl -sL "$LUV_URL" -o "$TMP/love-windows.zip"
  unzip -q "$TMP/love-windows.zip" -d "$TMP/love-win"
  cp "$TMP/$GAME_NAME-$GAME_VERSION.love" "$TMP/love-win/game.love"
  (cd "$TMP/love-win" && zip -qr "$WORKDIR/$WIN_ZIP" .)
  echo "  → Gerado: $WIN_ZIP"
}

# Função: Linux AppImage
build_linux() {
  echo "→ Build Linux (AppImage)"
  APPIMG="$DIST/${GAME_NAME}-${GAME_VERSION}-linux-x86_64.AppImage"
  # Baixa AppDir template do LÖVE
  LUV_URL="https://github.com/love2d/love/releases/download/${LOVE_VERSION}/love-${LOVE_VERSION}-x86_64.AppImage"
  curl -sL "$LUV_URL" -o "$TMP/love.AppImage"
  chmod +x "$TMP/love.AppImage"
  # Cria AppImage incorporando .love
  mkdir -p "$TMP/AppDir/usr/bin"
  cp "$TMP/love.AppImage" "$TMP/AppDir/usr/bin/love"
  mkdir -p "$TMP/AppDir/usr/share/applications"
  cat > "$TMP/AppDir/$GAME_NAME.desktop" <<EOF
[Desktop Entry]
Type=Application
Name=$GAME_NAME
Exec=love %f
Icon=love
Categories=Game;
EOF
  cp "$TMP/$GAME_NAME-$GAME_VERSION.love" "$TMP/AppDir/$GAME_NAME.love"
  # Empacota com appimagetool (assume instalado)
  appimagetool "$TMP/AppDir" "$APPIMG"
  echo "  → Gerado: $APPIMG"
}

# Função: macOS .app + .dmg
build_macos() {
  echo "→ Build macOS"
  MAC_APP="$BUILD/$GAME_NAME.app"
  DMG="$DIST/${GAME_NAME}-${GAME_VERSION}-mac.dmg"
  # Baixa template macOS
  LUV_URL="https://github.com/love2d/love/releases/download/${LOVE_VERSION}/love-${LOVE_VERSION}-macos.zip"
  unzip -q <(curl -sL "$LUV_URL") -d "$TMP"
  mv "$TMP/LÖVE.app" "$MAC_APP"
  cp "$TMP/$GAME_NAME-$GAME_VERSION.love" "$MAC_APP/Contents/Resources/game.love"
  mv "$MAC_APP/Contents/Info.plist" "$MAC_APP/Contents/Info.plist.bak"
  cat > "$MAC_APP/Contents/Info.plist" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC ...>
<plist version="1.0">
<dict>
  <key>CFBundleName</key><string>$GAME_NAME</string>
  <key>CFBundleExecutable</key><string>love</string>
  <key>CFBundleVersion</key><string>$GAME_VERSION</string>
  <!-- mantenha as demais chaves de LÖVE -->
</dict>
</plist>
EOF
  # Cria DMG
  hdiutil create -volname "$GAME_NAME" -srcfolder "$MAC_APP" -ov -format UDZO "$DMG"
  echo "  → Gerado: $DMG"
}

# Função: Android .apk
build_android() {
  echo "→ Build Android APK"
  ANDROID_DIR="$TMP/android"
  # Clona template love-android-sdl2 se não existir
  if [ ! -d "$ANDROID_DIR" ]; then
    git clone --depth=1 https://github.com/love2d/love-android-sdl2.git "$ANDROID_DIR"
  fi
  # Copia .love
  cp "$TMP/$GAME_NAME-$GAME_VERSION.love" "$ANDROID_DIR/assets/main.love"
  # Ajusta versão
  sed -i "" "s/versionName \".*\"/versionName \"$GAME_VERSION\"/g" "$ANDROID_DIR/app/build.gradle"
  cd "$ANDROID_DIR"
  ./gradlew assembleRelease
  APK_SRC="$(find app/build/outputs/apk/release -name '*.apk' | head -n1)"
  cp "$APK_SRC" "$DIST/${GAME_NAME}-${GAME_VERSION}-android.apk"
  echo "  → Gerado: ${GAME_NAME}-${GAME_VERSION}-android.apk"
}

# Executa builds
build_windows
build_linux
build_macos
build_android

echo "✔ Todas as builds geradas em dist/"
```

---

## 📚 7. Construtor e executor multiplataforma ([lover](https://github.com/Wolfyxon/lover))

Construtor e executor multiplataforma de linha de comando para projetos Love2D. Você pode facilmente construir seu jogo para todas as plataformas suportadas com um único comando.

```sh
lover build win64 linux
```

---

## 📊 8. Automação com CI/CD

### GitHub Actions

```yaml
# .github/workflows/build.yml
name: Build Game

on:
  name: Build LÖVE2D Releases

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up LÖVE version
        run: echo "LOVE_VERSION=11.5" >> $GITHUB_ENV

      - name: Install dependencies on Linux
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip love
          # caso precise de versão específica:
          # wget https://github.com/love2d/love/releases/download/${{ env.LOVE_VERSION }}/love-${{ env.LOVE_VERSION }}-ubuntu.deb
          # sudo dpkg -i love-*.deb

      - name: Install dependencies on macOS
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install zip unzip
          brew tap love2d/love
          brew install --cask love

      - name: Install dependencies on Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install zip unzip -y
          choco install love -y

      - name: Run build script
        run: bash build.sh --only ${{ matrix.os }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-${{ matrix.os }}
          path: dist/
```

---

## ✅ Resumo Final

Você aprendeu a:

-   ✅ Criar arquivos `.love` manualmente e automaticamente
-   ✅ Gerar executáveis para Windows
-   ✅ Distribuir para Linux (AppImage, .deb)
-   ✅ Criar app bundles para macOS
-   ✅ Preparar builds para Android
-   ✅ Automatizar todo o processo de build
-   ✅ Configurar CI/CD para releases automáticas

#### Extra: Assinatura de Código e Distribuição (Somente para informação)

Windows: Authenticode com signtool

-   Gere ou adquira um certificado Code Signing (arquivo .pfx) junto a uma CA confiável.
-   Instale o certificado no Windows Certificate Store ou mantenha o .pfx protegido como segredo no CI.
-   Use o signtool (incluído no Windows SDK) para assinar seu executável:

```cmd
signtool sign /fd SHA256 /a /f path/to/cert.pfx /p CERT_PASSWORD MyGame.exe
```

-   Após assinar, valide a assinatura com:

```cmd
signtool verify /pa /v MyGame.exe
```

-   Embale o executável assinado junto das DLLs e liblove em um ZIP ou installer MSI.

macOS: codesign e notarização

-   Registre-se no Apple Developer Program e crie um “Developer ID Application” no portal.
-   Instale o certificado no macOS Keychain (pode usar variáveis de ambiente no CI para importá-lo).
-   Assine o bundle .app com:

```sh
codesign --deep --force --options runtime \
  --sign "Developer ID Application: Seu Nome (TEAMID)" \
  MyGame.app
```

-   Notarize sua aplicação no Apple Server:

```sh
xcrun altool --notarize-app \
  --primary-bundle-id com.suaempresa.mygame \
  --username APPLE_ID --password APP_SPECIFIC_PASSWORD \
  --file MyGame.app.zip
```

-   Aguarde a aprovação, depois fixe a nota interna com:

```sh
xcrun stapler staple MyGame.app
```

-   Distribua o .dmg ou installer via website ou Mac App Store Connect (se aplicável).

Android: keystore e apksigner

-   Gere um keystore seguro localmente ou no CI:

```sh
keytool -genkeypair -v -keystore mygame.keystore \
  -alias mygame_alias -keyalg RSA -keysize 2048 \
  -validity 10000
```

-   Configure o build.gradle para usar esse keystore em signingConfigs.release.
-   Execute o Gradle para produzir o APK de release:

```sh
./gradlew assembleRelease
```

-   Assine o APK com o apksigner:

```sh
apksigner sign --ks mygame.keystore \
  --ks-key-alias mygame_alias \
  app-release-unsigned.apk
```

-   Verifique a assinatura:

```sh
apksigner verify app-release-unsigned.apk
```

-   Publique no Google Play Console (APK ou AAB), configure tracks de testes e produção.
