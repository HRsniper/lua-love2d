# Capítulo 14: O Ambiente Lua (Lua State)

`_G`: O ambiente global

`_ENV` Gerenciamento do ambiente

## Exemplo 1: Acessando e Modificando \_G

```lua
-- Inicialmente, 'minha_var_global' não existe
print(_G.minha_var_global) -- nil

_G.minha_var_global = "Valor Global"
print(minha_var_global) -- Valor Global (acesso direto sem _G)

-- Remover uma variável global
_G.minha_var_global = nil
print(minha_var_global) -- nil
```

## Exemplo 2:

`load` é uma ferramenta poderosa para compilar código Lua a partir de uma string ou de um arquivo, retornando-o como uma função executável.

load tem modo de leitura, pode ser:

-   "**t**" Quando o chunk é uma string de código Lua, como "print('Olá')"
-   "**b**" Quando o chunk é um bytecode pré-compilado (gerado por string.dump)
-   "**bt**" Aceita ambos os formatos — útil quando não se sabe o tipo

```lua
local codigo_lua = [[
    local a = 10
    local b = 20
    return a + b
]]

-- Carrega o código como uma função anônima
local func_carregada = load(codigo_lua)

if func_carregada then
    local resultado = func_carregada() -- Executa a função carregada
    print("Resultado do código carregado:", resultado)
    -- Resultado do código carregado: 30
else
    error("Erro ao carregar código.")
end
```

`dofile` Abre o arquivo indicado e executa seu conteúdo como um trecho Lua. Quando chamada sem argumentos, dofile executa o conteúdo da entrada padrão (stdin).

```sh
# meu_script.lua
echo -e 'local x = 5\nprint("Dentro de meu_script.lua, x é: " .. x)\nreturn x * 2' > meu_script.lua
```

```lua
--[[ Suponha que você tenha um arquivo "meu_script.lua" com:
    local x = 5
    print("Dentro de meu_script.lua, x é: " .. x)
    return x * 2
]]

local file_path = "meu_script.lua"
local resultado = dofile(file_path)
print("Resultado de dofile:", resultado)
```

```lua
local file_path = "meu_script.lua"
local chunk, err = loadfile(file_path)

if chunk then
    local success, result = pcall(chunk)
    if success then
        print("Resultado de dofile simulado:", result)
    else
        print("Erro ao executar o script carregado:", result)
    end
else
    print("Erro ao carregar o arquivo:", err)
end
```

## Exemplo 3: Ambiente Personalizado \_ENV

```lua
-- Criando um ambiente com apenas algumas funções
local meu_ambiente = {
    print = print, -- Permitir print
    math = { -- Permitir acesso a math, mas não a tudo nele
        sqrt = math.sqrt,
        pi = math.pi
    }
-- outra_coisa = 123 -- Não está definido aqui
}

-- Cria uma função que será executada com o ambiente personalizado
local func_com_ambiente = load("print('Raiz de 9:', math.sqrt(9))", "chunkName", "t", meu_ambiente)

if func_com_ambiente then
    local success, err = pcall(func_com_ambiente)
    if not success then
        print("Erro de execução:", err)
    end
else
    print("Erro ao carregar a função com ambiente.")
end
-- Raiz de 9: 3.0
```
