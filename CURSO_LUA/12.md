# Capítulo 12: Tipos de Dados Avançados `Metatables` e `Metamethods`

A `__index` é um metamethod "lookup", é um dos mais importantes. Ele é usado para implementar mecanismos de herança e acesso a membros em Lua. Portanto, "lookup" é o mecanismo de busca de valores através de chaves

Outras metamethods comuns: `__newindex`, `__add`, `__sub`, `__mul`, `__div`, `__lt`, `__le`, `__eq`, `__tostring`, `__call`.

## Exemplo 1: \_\_index para Lookup de Métodos:

```lua
local Animal = {}
Animal.__index = Animal -- Importante: Animal aponta para si mesmo para lookup Permite que instâncias acessem métodos

function Animal:new(nome)
    local self  = setmetatable({}, Animal) -- Cria uma nova tabela com Animal como metatable
    self.nome = nome
    return self
end

function Animal:falar()
    print(self.nome .. " faz um som.")
end

local cachorro = Animal:new("Rex")
cachorro:falar() -- Rex faz um som. (encontra 'falar' em Animal.__index)
```

## Exemplo 2: \_\_newindex para Validar Atribuições:

```lua
local Pessoa = {}
Pessoa.__index = Pessoa

-- Define __newindex antes de criar o objeto para interceptar novas atribuições
Pessoa.__newindex = function(tabela, key, value)
    if key == "idade" and type(value) ~="number" then
        print("Erro: Idade deve ser um número.", value)
    else
        rawset(tabela, key, value) -- Usa rawset para evitar loop infinito
    end
end

function Pessoa:new(nome)
    local self = setmetatable({}, Pessoa)
    self.nome = nome
    return self
end


local joao = Pessoa:new("João")
joao.idade = 30
print(joao.idade)    -- 30
```

## Exemplo 3: \_\_add para Sobrecarga de Operador:

```lua
local Vetor2D = {}
Vetor2D.__index = Vetor2D

function Vetor2D:new(x, y)
    local self = setmetatable({}, Vetor2D)
    self.x = x or 0
    self.y = y or 0
    return self
end

-- Define como somar dois Vetores2D
Vetor2D.__add = function(v1, v2)
    local v = Vetor2D:new(v1.x + v2.x, v1.y + v2.y)
    return v
end

local v1 = Vetor2D:new(10, 4)
local v2 = Vetor2D:new(20, 5)
local v3 = v1 + v2 -- Usa __add
print("Vetor soma:", v3.x, v3.y) -- Vetor soma: 30 9
```

## Exemplo 4: \_\_tostring para Representação de String

```lua
local Ponto = {}
Ponto.__index = Ponto

function Ponto:new(x, y)
    local p = {}
    setmetatable(p, Ponto)
    p.x = x or 0
    p.y = y or 0
    return p
end

Ponto.__tostring = function(p)
    return string.format("Ponto(%d, %d)", p.x, p.y)
end

local meu_ponto = Ponto:new(10, 20)
print(meu_ponto) -- Ponto(10, 20) (chama __tostring automaticamente)

```

## Exemplo 5: \_\_call para Tornar Tabelas "Chamáveis"

```lua
local Calculadora = {}
Calculadora.__index = Calculadora

function Calculadora:new()
    local self = setmetatable({}, Calculadora)
    return self
end

-- Define como a tabela Calculadora como Chamável
Calculadora.__call = function(self, op, v1, v2)
    if op == "+" then return v1 + v2 end
    if op == "-" then return v1 - v2 end
    if op == "*" then return v1 * v2 end
    if op == "/" then return v1 / v2 end
    return "Operação desconhecida"
end

local calc = Calculadora:new()

print("10 + 5 =", calc("+", 10, 5)) -- Chama __call
-- 10 + 5 = 15
print("10 * 5 =", calc("*", 10, 5))
-- 10 * 5 = 50
```
