# Cap√≠tulo 20: Ferramentas e Bibliotecas

biblioteca utf-8 fornece suporte b√°sico para codifica√ß√£o UTF-8. Ele fornece todas as suas fun√ß√µes dentro da tabela utf8.

`utf8.char(...)`: Recebe um ou mais pontos de c√≥digo (n√∫meros inteiros) e retorna uma string contendo as sequ√™ncias de bytes UTF-8 correspondentes, concatenadas.

```lua
local utf8 = require("utf8")
local char1 = utf8.char(72, 101, 108, 108, 111) -- Retorna "Hello"
local char2 = utf8.char(8331) -- Retorna '‚àë' (s√≠mbolo Sigma)
print(char1)
print(char2)
```

`utf8.len(s [, i [, j]])`: Retorna o n√∫mero de caracteres UTF-8 na string s que come√ßam entre as posi√ß√µes de byte i e j (inclusive). Isso √© crucial, pois um √∫nico caractere pode ser representado por v√°rios bytes.

```lua
local utf8 = require("utf8")
local str = "Ol√°, mundo! üëã"
print("N√∫mero de caracteres:", utf8.len(str)) -- Contar√° corretamente os caracteres, incluindo o emoji
print("Tamanho em bytes:", #str) -- Isso retornar√° o tamanho em bytes, que √© diferente
```

`utf8.offset(s, n [, i])`: Retorna o deslocamento em bytes do caractere que est√° n posi√ß√µes de caractere √† frente da posi√ß√£o de byte i. Um n negativo conta os caracteres para tr√°s.

```lua
local utf8 = require("utf8")
local str = "‰Ω†Â•Ω‰∏ñÁïå" -- "Ol√° Mundo" em chin√™s
local offset = utf8.offset(str, 3) -- Obt√©m o deslocamento em bytes do 3¬∫ caractere
print("Deslocamento do 3¬∫ caractere:", offset)
```

`utf8.codepoint(s [, i [, j]])`: Retorna os pontos de c√≥digo Unicode (como inteiros) dos caracteres na string s que come√ßam entre as posi√ß√µes de byte i e j (inclusive). Se i e j forem omitidos, a string inteira √© processada.

```lua
local utf8 = require("utf8")
local str = "Ol√°, mundo! üëã"
local codepoints = {}
for i = 1, utf8.len(str) do
    local byte_index = utf8.offset(str, i)
    codepoints[i] = utf8.codepoint(str, byte_index)
end

for _, cp in ipairs(codepoints) do
    print(cp, utf8.char(cp)) -- mostra o n√∫mero e o caractere
end
```

`utf8.codes(s)`: Retorna valores que permitem iterar sobre todos os caracteres da string s. A cada itera√ß√£o, voc√™ obt√©m a posi√ß√£o em bytes (p) e o ponto de c√≥digo (c) do caractere.

```lua
local utf8 = require("utf8")
local str = "Lua UTF-8"
for pos, code in utf8.codes(str) do
    print(string.format("Posi√ß√£o: %d, Ponto de C√≥digo: %d", pos, code))
end
```

`utf8.charpattern`: Este √© um padr√£o de string que corresponde exatamente a uma sequ√™ncia de bytes UTF-8. √â √∫til para correspond√™ncia de padr√µes dentro de strings UTF-8.

```lua
local utf8 = require("utf8")
local str = "Testa s√≠mbolo ‚Ç¨"
for char in str:gmatch(utf8.charpattern) do
    print("Caractere encontrado:", char)
end
```

instalar, configurar, utilizar e criar pacotes com LuaRocks, entendendo seu funcionamento interno e aplicando-o em projetos reais com Lua.

## Introdu√ß√£o ao LuaRocks

```sh
# Verificando instala√ß√£o
luarocks --version
lua -v
```

## Usando LuaRocks

```sh
# Instalando um pacote
luarocks install luasocket

# Listando pacotes
luarocks list

# Removendo
luarocks remove luasocket
```

```sh
# Instalar o m√≥dulo 'luafilesystem' para manipula√ß√£o de arquivos
luarocks install luafilesystem
```

```lua
-- Usando o m√≥dulo instalado
local lfs = require("lfs")

-- Listar arquivos do diret√≥rio atual
for file in lfs.dir(".") do
  print("Arquivo encontrado:", file)
end
```

## Tipos de pacotes

```sh
# Buscar pacotes relacionados a JSON
luarocks search json

# Mostrar detalhes do pacote 'lua-cjson' instalado
luarocks show lua-cjson
```

## Testando M√≥dulo com Depend√™ncia

```sh
# Instalar m√≥dulo de teste 'busted'
luarocks install busted
```

```lua
-- test_meumodulo.lua:
local meumodulo = require("meumodulo")

describe("meumodulo", function()
    it("deve retornar sauda√ß√£o correta", function()
        assert.has_no.errors(function()
            meumodulo.saudacao("Jo√£o")
        end)
    end)
end)
```

```sh
# Executar testes
busted test_meumodulo.lua
```

## Gerenciando Depend√™ncias

```txt
saudador/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ saudador.lua
‚îÇ   ‚îî‚îÄ‚îÄ util.lua
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îî‚îÄ‚îÄ test_saudador.lua
‚îî‚îÄ‚îÄ saudador-1.0-1.rockspec
```

```lua
-- Exemplo de "saudador-1.0-1.rockspec"
package = "saudador"
version = "1.0-1"

source = {
  url = "file://."
}

description = {
  summary = "Um m√≥dulo Lua para sauda√ß√µes personalizadas",
  detailed = [[
    Este pacote fornece fun√ß√µes simples para gerar sauda√ß√µes em portugu√™s.
    Inclui suporte a nomes, hor√°rios e mensagens customizadas.
  ]],
  homepage = "https://github.com/<user>/saudador",
  license = "MIT"
}

dependencies = {
  "lua >= 5.4",
  "luafilesystem",
  "busted >= 2.0"
}

build = {
  type = "builtin",
  modules = {
    saudador = "src/saudador.lua",
    ["saudador.util"] = "src/util.lua"
  }
}

test = {
  type = "busted",
  file = "tests/test_saudador.lua"
}
```

```sh
# Instalando com depend√™ncias
luarocks make meumodulo-1.0-1.rockspec
```

## Validando rockspec

```sh
luarocks lint mymodule-1.0-1.rockspec
```

## Criando Pacotes

```lua
-- Arquivo src/util.lua
local U = {}

function U.prefixo()
  local hora = os.date("*t").hour
  if hora < 12 then
    return "Bom dia, "
  elseif hora < 18 then
    return "Boa tarde, "
  else
    return "Boa noite, "
  end
end

return U

-- Arquivo src/saudador.lua
local util = require("saudador.util")

local M = {}

function M.saudacao(nome)
  return util.prefixo() .. nome .. "!"
end

return M

-- Arquivo tests/test_saudador.lua
local saudador = require("saudador")

describe("saudador", function()
    it("deve retornar uma sauda√ß√£o com nome", function()
        local resultado = saudador.saudacao("Jo√£o")
        assert.is_true(resultado:match("Jo√£o"))
    end)
end)
```

```sh
# Criando e testando o pacote
luarocks make saudador-1.0-1.rockspec
luarocks test saudador
```

## Configura√ß√µes

Localiza√ß√£o padr√£o:

-   Global: `/etc/luarocks/config-5.4.lua`
-   Usu√°rio: `~/.luarocks/config-5.4.lua`

```sh
# Instalando localmente apenas para o usu√°rio atual.
luarocks install dkjson --local

# Usando m√∫ltiplas vers√µes
luarocks install luasocket --lua-version=5.4
```

## BOAS PR√ÅTICAS COM LUAROCKS

Use rocks_trees para isolar ambientes Ideal para projetos com depend√™ncias espec√≠ficas

```sh
luarocks install dkjson --tree=./deps --lua-version=5.4
```

Use luarocks lint para validar seu .rockspec

```sh
luarocks lint saudador-1.0-1.rockspec
```

Use --lock para travar vers√µes Garante que todos os colaboradores usem as mesmas vers√µes de depend√™ncias

```sh
luarocks install dkjson --tree=./deps --lua-version=5.4 --lock
```
